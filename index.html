<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Paco</title>
<style>
    * {
        user-select: none;
    }

    body, html {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e4e4e4;
    }
    #gameContainer {
        width: 600px;
        height: 200px;
        position: relative;
        background-color: #fff;
        overflow: hidden;
    }
    #background {
        position: absolute;
        width: 80%;
        left: 10%;
        top: 50%;
        transform: translateY(-50%);
        filter: blur(.7px);
    }
    #paco {
        position: absolute;
        bottom: 0;
    }
    #sprite {
        position: absolute;
        bottom: -10px;
        left: 0;
    }
    .chocolateBar {
        width: 40px;
        height: 60px;
        position: absolute;
        bottom: 0;
        background-image: url('./assets/misc/chocolate_bar.png');
        background-size: contain;
        background-repeat: no-repeat;
    }
    #start-btn {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        background-color: aqua;
        cursor: pointer;
        border-radius: 15px;
        color: black;
        font-family: Arial, Helvetica, sans-serif;
        z-index: 1;
    }
</style>
</head>
<body>
<div id="start-btn">Start</div>
<div id="gameContainer">
    <img id="background" src="./assets/misc/background.jpg"/>
    <div id="paco">
        <img
            src="./assets/paco/walk_1.png" id="sprite"
            width="50" contain
        >
    </div>
</div>
<script>

    document.addEventListener('DOMContentLoaded', () => {
        const background = document.getElementById('background');
        const paco = document.getElementById('paco');
        const gameContainer = document.getElementById('gameContainer');
        const sprite = document.getElementById('sprite');
        const chocolateHeight = 50;
        const music = new Audio('./assets/music/soundtrack.mp3');
        music.volume = 0.5;
        music.loop = true;
        let isJumping = false;
        let gravity = 0.7;
        let gameSpeed = 5;
        let elapsedTime = 0;
        let chocolateBarInterval;
        let verticalVelocity = 10;
        let direction = 1;
    
        function scale() {
            let scale = window.innerWidth / 650;
            gameContainer.style.transform = `scale(${scale})`;
        }
        scale();
        window.addEventListener('resize', scale);

        function startGame() {
            document.addEventListener('keydown', control);
            document.addEventListener('click', handleClick);
            generateChocolateBar();
            setInterval(() => {
                gameSpeed += .5;
                elapsedTime++;
            }, 1000);
            setInterval(moveBackground, 20);
            startAnimation()
            music.play();
        }

        function restartGame() {
            gameContainer.innerHTML = ''
            gameContainer.appendChild(background);
            gameContainer.appendChild(paco);
            document.addEventListener('keydown', control);
            document.addEventListener('click', handleClick);
            generateChocolateBar();
            gameSpeed = 5;
            elapsedTime = 1;
            music.play();
        }

        function moveBackground() {
            let backgroundPosition = parseInt(window.getComputedStyle(background).getPropertyValue('left'));
            if (backgroundPosition < -450) {
                background.style.left = 450 + 'px';
                return;
            }
            background.style.left = backgroundPosition - gameSpeed / 2 + 'px';
        }

        function startAnimation() {
            let tick = 0
            setInterval(() => {
                tick++
            }, 500)
            setInterval(() => {
                if(isJumping) {
                    sprite.src = './assets/paco/jump.png';
                    return;
                }

                if(tick % 2) {
                    sprite.src = './assets/paco/walk_1.png';
                }
                else {
                    sprite.src = './assets/paco/walk_2.png';
                }
            }, 100)
        }

        function handleClick() {
            if (!isJumping) {
                isJumping = true;
                jump();
            } else {
                forceFall();
            }
        }
        function control(e) {
            if(e.keyCode === 32) {
                if(isJumping) {
                    forceFall();
                }
                else {
                    isJumping = true;
                    jump();
                }
            }
        }
    
        function forceFall() {
            verticalVelocity = 50;
            direction = -1;
        }
        function jump() {
            const maxHeight = chocolateHeight * 2;
            let height = 0;
            verticalVelocity = 10;
            direction = 1;

            let jumpInterval = setInterval(function () {
                let pacoPosition = parseInt(window.getComputedStyle(paco).getPropertyValue('bottom'));
                if (pacoPosition >= maxHeight || direction === -1) {
                    clearInterval(jumpInterval);

                    setTimeout(() => {
                        let fallInterval = setInterval(function () {
                            direction = -1;
                            if (height <= 0) {
                                clearInterval(fallInterval);
                                isJumping = false;
                                height = 0;
                                paco.style.bottom = height + 'px';
                                return;
                            }
                            height += verticalVelocity * gravity * direction;
                            paco.style.bottom = height + 'px';
                        }, 20);
                    }, 0);
                }
                else {
                    height += verticalVelocity * gravity * direction;
                    paco.style.bottom = height + 'px';
                }
            }, 20);
        }
    
        function generateChocolateBar() {
            let randomTime = Math.random() * 1000 + 1000 - elapsedTime * 15;
            let chocolateBar = document.createElement('div');
            chocolateBar.classList.add('chocolateBar');
            gameContainer.appendChild(chocolateBar);
            chocolateBar.style.right = 0;
            moveChocolateBar(chocolateBar);
    
            chocolateBarInterval = setTimeout(generateChocolateBar, randomTime);
        }
    
        function moveChocolateBar(bar) {
            let moveInterval = setInterval(function () {
                let barPosition = parseInt(window.getComputedStyle(bar).getPropertyValue('right'));
                // Detectar colisión
                if (barPosition > 523 && barPosition < 573 && paco.offsetTop >= 150) {
                    music.pause();
                    music.currentTime = 0;
                    alert("¡Juego terminado! Puntaje: " + elapsedTime + " segundos");
                    clearInterval(moveInterval);
                    clearTimeout(chocolateBarInterval);
                    document.removeEventListener('keyup', control);
                    // Reiniciar el juego
                    restartGame();
                }

                if (barPosition > 600) {
                    clearInterval(moveInterval);
                    bar.remove();
                    return;
                }

                bar.style.right = barPosition + gameSpeed + 'px';
            }, 20);
        }
    
        document.getElementById('start-btn')
            .addEventListener('click', () => {
                startGame();
                document.getElementById('start-btn').style.display = 'none';
            });
    });
    

</script>
</body>
</html>
